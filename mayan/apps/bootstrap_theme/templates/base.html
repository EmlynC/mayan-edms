{% extends 'skeleton.html' %}

{% load i18n %}

{% load project_tags %}
{% load navigation_tags %}
{% load settings %}
{% load search_tags %}
{% load static %}
{% load main_settings_tags %}
{% load variable_tags %}
{% load registration_tags %}
{% load compress %}

{% block meta %}
  {% if html_redirect %}
    <META HTTP-EQUIV="refresh" CONTENT="{{ html_redirect_timeout|default:'2' }};{{ html_redirect|safe }}">
  {% endif %}
{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{% static 'packages/fancyapps-fancyBox-18d1712/source/jquery.fancybox.css' %}" type="text/css" media="screen" />
  <link rel="stylesheet" href="{% static 'css/fancybox.css' %}" type="text/css" media="screen" />
{% endblock %}

{% block javascript_head %}
  {% if new_window_url %}
  <script type="text/javascript">
    window.open('{{ new_window_url|safe }}','{{ new_window_url_name|default:"_blank" }}','toolbar=1,scrollbars=1,location=1,status=1,menubar=1,resizable=1');
  </script>
  <noscript>
    <META HTTP-EQUIV="refresh" CONTENT="{{ new_window_url_timeout|default:'2' }};{{ new_window_url|safe }}">
  </noscript>
  {% endif %}
{% endblock %}

{% block html_title %}{% project_name %}
  {{ request.new_window_url }}
  {% block title %}{% endblock %}
{% endblock %}

{% block project_name %}
  {% project_name %}{% if debug %} {% trans "(DEBUG)" %}{% endif %}
{% endblock %}

{% block body_content %}

{% if not bootstrap_theme_hide_menus %}
      <header class="navbar navbar-default" id="top" role="banner">
          <div class="navbar-header">
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="{% url 'home' %}" class="navbar-brand">{% project_name %}</a></h1></a>
          </div>
          <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
            <ul class="nav navbar-nav">

              {% block navigation_main %}
                {% get_top_menu_links %}
                {% for link in menu_links %}
                  {% with 'true' as as_li %}
                    {% with 'true' as hide_active_anchor %}
                      {% with 'active' as li_class_active %}
                        {% with 'first' as li_class_first %}
                          {% include 'generic_subnavigation.html' %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endfor %}
              {% endblock %}
              </ul>
              {% block navigation_user %}
              <ul class="nav navbar-nav navbar-right">
                <li>
                  <a href="{% url 'current_user_details' %}" title="{% trans 'User details' %}"><span class="glyphicon glyphicon-user"></span>{{ user.get_full_name|default:user }}</a>
                </li>

                {% get_setting "LOGIN_URL" as login_url %}
                <li>
                  <a class="logout"
                     href="{% if not user.is_authenticated %}{% url 'login_view' %}?next=/{% else %}{% url 'logout_view' %}{% endif %}"
                     >
                       {% if not user.is_authenticated %}{% trans 'Login' %}{% else %}{% trans 'Logout' %}{% endif %}
                  </a>
                </li>
              </ul>
              {% endblock %}
          </nav>
      </header>
    {% endif %}

    {% block main %}
      <div id="main" class="{% block main_div_class %}col-lg-10 col-md-8 col-sm-8{% endblock %}">

        {% if messages %}
        <div class="row">
          {% for message in messages %}
            <div class="alert alert-info alert-dismissible" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}

        {% block navigation_secondary %}
          {% if navigation_object_list %}
            {% for navigation_object_dict in navigation_object_list %}
              {% copy_variable navigation_object_dict.object as "navigation_object_name" %}
              {% get_object_navigation_links "form_header" as form_navigation_links %}
              {% if form_navigation_links %}
                <div class="secondary-navigation">
                  <ul class="list-unstyled">
                    {% with form_navigation_links as object_navigation_links %}
                      {% with 'true' as as_li %}
                        {% with 'true' as hide_active_anchor %}
                          {% with 'active' as li_class_active %}
                            {% with 'first' as li_class_first %}
                              {% include 'generic_navigation.html' %}
                            {% endwith %}
                          {% endwith %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  </ul>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {% get_object_navigation_links "form_header" as form_navigation_links %}
            {% if form_navigation_links %}
              <div class="secondary-navigation">
                <ul class="nav nav-pills" role="tablist">
                  {% with form_navigation_links as object_navigation_links %}
                    {% with 'true' as as_li %}
                      {% with 'true' as hide_active_anchor %}
                        {% with 'active' as li_class_active %}
                          {% with 'first' as li_class_first %}
                            {% include 'generic_navigation.html' %}
                          {% endwith %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                </ul>
              </div>
            {% endif %}
          {% endif %}
        {% endblock %}


        {% block main_content %}{% endblock %}

      </div>
    {% endblock %}


      <div id="sidebar" class="{% block sidebar_div_class %}col-lg-2 col-md-4 col-sm-4{% endblock %}">
          {% get_main_setting "SIDE_BAR_SEARCH" as side_bar_search %}
          {% if side_bar_search and not bootstrap_theme_hide_menus %}
            {% with 'true' as side_bar %}
              {% with 'true' as form_hide_required_text %}
                {% with '' as read_only %}
                  {% with '' as object %}
                    {% search_form %}
                  {% endwith %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          {% endif %}

          {% get_object_navigation_links "secondary_menu" as object_navigation_links %}
          {% if object_navigation_links %}
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3>{% trans "Secondary menu" %}</h3>
              </div>
              <div class="panel-body">
                <ul class="navigation list-unstyled">
                {% with 'true' as as_li %}
                  {% include 'generic_navigation.html' %}
                {% endwith %}
              </ul>
              </div>
            </div>
          {% endif %}

          {% if navigation_object_list %}
            {% for navigation_object_dict in navigation_object_list %}
              {% copy_variable navigation_object_dict.object as "navigation_object_name" %}
              {% get_object_navigation_links as object_navigation_links %}
              {% if object_navigation_links %}
                <div class="panel panel-default">
                  <div class="panel-heading">
                  {% if navigation_object %}
                    {% if navigation_object_dict.name %}
                      <h3>{% blocktrans with navigation_object_dict.name as name %}Actions for {{ name }}: {{ navigation_object }}{% endblocktrans %}</h3>
                    {% else %}
                      <h3>{% blocktrans %}Actions for: {{ navigation_object }}{% endblocktrans %}</h3>
                    {% endif %}
                  {% else %}
                    <h3>{% trans 'Available actions' %}</h3>
                  {% endif %}
                  </div>
                  <div class="panel-body">
                    <ul class="navigation list-unstyled">
                      {% with 'true' as as_li %}
                        {% include 'generic_navigation.html' %}
                      {% endwith %}
                    </ul>
                  </div>
                </div>
              {% endif %}
              {% get_object_navigation_links "related" as object_navigation_links %}
              {% if object_navigation_links %}
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <h3>{% trans "Related actions" %}</h3>
                  </div>
                  <div class="panel-body">
                    <ul class="navigation list-unstyled">
                    {% with 'true' as as_li %}
                      {% include 'generic_navigation.html' %}
                    {% endwith %}
                    </ul>
                  </div>
                </div>
              {% endif %}
              {% get_object_navigation_links "sidebar" as object_navigation_links %}
              {% if object_navigation_links %}
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <h3>{% trans 'Other available actions' %}</h3>
                  </div>
                  <div class="panel-body">
                      <ul class="navigation list-unstyled">
                      {% with 'true' as as_li %}
                        {% include 'generic_navigation.html' %}
                      {% endwith %}
                    </ul>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {% get_object_navigation_links as object_navigation_links %}
            {% if object_navigation_links %}
              <div class="panel panel-default">
                <div class="panel-heading">
                  {% if navigation_object %}
                  {% if object_name %}
                    <h3>{% blocktrans %}Actions for {{ object_name }}: {{ navigation_object }}{% endblocktrans %}</h3>
                  {% else %}
                    <h3>{% blocktrans %}Actions for: {{ navigation_object }}{% endblocktrans %}</h3>
                  {% endif %}
                {% else %}
                  <h3>{% trans 'Actions' %}</h3>
                {% endif %}
                </div>
                <div class="panel-body">
                  <ul class="navigation list-unstyled">
                    {% with 'true' as as_li %}
                      {% include 'generic_navigation.html' %}
                    {% endwith %}
                  </ul>
                </div>
              </div>
            {% endif %}
            {% get_object_navigation_links "related" as object_navigation_links %}
            {% if object_navigation_links %}
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h3>{% trans 'Related actions' %}</h3>
                </div>
                <div class="panel-body">
                  <ul class="navigation list-unstyled">
                  {% with 'true' as as_li %}
                    {% include 'generic_navigation.html' %}
                  {% endwith %}
                  </ul>
                </div>
              </div>
            {% endif %}
          {% endif %}

          {% get_object_navigation_links "sidebar" as object_navigation_links %}
          {% if object_navigation_links %}
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3>{% trans "Other available actions" %}</h3>
              </div>
              <div class="panel-body">
                <ul class="navigation list-unstyled">
                  {% with 'true' as as_li %}
                    {% include 'generic_navigation.html' %}
                  {% endwith %}
                </ul>
              </div>
            </div>
          {% endif %}

          {% get_sidebar_templates as sidebar_templates %}
          {% for template in sidebar_templates %}
            {% with 'true' as side_bar %}
              {% include template %}
            {% endwith %}
          {% endfor %}

        {% block sidebar_content %}
        {% endblock %}
      </div>

  {% block javascript_foot %}
    {% if enable_scroll_js %}
      <script type="text/javascript" charset="utf-8" src="{% static 'packages/jquery.scrollTo.js' %}"></script>
      <script type="text/javascript" charset="utf-8" src="{% static 'packages/jquery.localscroll.js' %}"></script>
    {% endif %}

    <script type="text/javascript">
      function dismissAlert($element){
        $element.parent().parent().addClass('fadeOutUp').fadeOut('slow');
      }

      $(document).ready(function() {
        var dismissTimer = setInterval(function(){
          $('.success').each(function(){
            dismissAlert($(this).find('.dismiss'));
          });

          clearInterval(dismissTimer);
        }, 2500);

        $('.dismiss').click(function(){
          dismissAlert($(this));
          return false;
        });
        $('.dismiss-all').click(function(){
          $('.message').each(function(){
            dismissAlert($(this).parent().find('.dismiss'));
          });
          return false;
        });
        $('th input:checkbox').click(function(e) {
          var table = $(e.target).closest('table');
          $('td input:checkbox', table).attr('checked', e.target.checked);
        });
      });

    jQuery(document).ready(function() {
      {% if not disable_auto_focus %}
        $("input:text:visible:not(#livesearch):not([readonly]):enabled:first").focus();
      {% endif %}
      $('form').submit(function(){
        $('button', this).click(function() {
          return false;
        });
        $(':submit', this).click(function() {
          return false;
        });
      });
      $('.scrollable').scrollview();
      $('.full-height').height($(window).height() - 230);
      $(window).resize(function() {
        $('.full-height').height($(window).height() - 230);
      });
      $('.no-parent-history', this).click(function() {
        location.replace(this.href);
        return false;
      });

      $("a.fancybox").fancybox({
        'openEffect'  : 'elastic',
        'closeEffect' : 'elastic',
        prevEffect  : 'none',
        nextEffect  : 'none',
        'titleShow' : true,
        'type'      : 'image',
        'autoResize': true
      });

      $("a.fancybox-staging").click(function(e) {
        var $this = $(this);

        $.get($this.attr('href'), function( result ) {
          if (result.status == 'success') {
            $.fancybox.open([
              {
                href : result.data,
                title : $this.attr('title'),
                'openEffect'  : 'elastic',
                'closeEffect' : 'elastic',
                prevEffect  : 'none',
                nextEffect  : 'none',
                'titleShow' : true,
                'type'      : 'image',
                'autoResize': true
              },
            ]);
          }
        });
        e.preventDefault();
      });

      $("a.fancybox-noscaling").fancybox({
        openEffect  : 'elastic',
        closeEffect : 'elastic',
        prevEffect  : 'none',
        nextEffect  : 'none',
        'titleShow' : true,
        'type'      : 'image',
        'autoResize': false
      });

      $("a.fancybox-iframe").fancybox({
        openEffect     : 'elastic',
        closeEffect    : 'elastic',
        'titleShow'    : false,
        'type'         : 'iframe',
        autoHeight     : false,
        width          : '99%',
        height         : '99%',
        minHeight      : '100%',
        minWidth       : '100%',
        'showNavArrows': false,
        'margin'       : 18,
      });

      function set_image_noninteractive(image) {
        // Remove border to indicate non interactive image
        image.removeClass('thin_border');
        container = image.parent().parent();
        // Save img HTML
        html = image.parent().html();
        // Remove anchor
        image.parent().remove();
        // Place again img
        container.html(html);
      }

      function load_document_image(image) {
        $.get(image.attr('data-src'), function( result ) {
          if (result.status == 'success') {
            image.attr('src', result.data);
          } else if (result.detail == 'unknown_file_format') {
            image.attr('src', "{% static 'images/mimetypes/unknown.png' %}");
            set_image_noninteractive(image);
          } else {
            image.attr('src', "{% static 'images/mimetypes/error.png' %}");
            set_image_noninteractive(image);
          }
        })
                .fail(function() {
                  image.attr('src', "{% static 'images/mimetypes/error.png' %}");
                  set_image_noninteractive(image);
                })
      }

      $('img.lazy-load').lazyload({
        appear: function(elements_left, settings) {
          load_document_image($(this));
        }
      });

      $('img.lazy-load-carousel').lazyload({
        container: $(".carousel-container"),
        appear: function(elements_left, settings) {
          var $this = $(this);
          $this.removeClass('lazy-load-carousel');
          load_document_image($this);
        },
        event: 'scrollstop'
      });

      $('img.lazy-load-interactive').lazyload({
        appear: function(elements_left, settings) {
          load_document_image($(this));
        }
      });
    });
    </script>
  {% endblock %}
{% endblock body_content %}